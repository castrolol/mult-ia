# syntax=docker/dockerfile:1.6

ARG NODE_VERSION=22.13.1
ARG APP_DIR=apps/web

FROM node:${NODE_VERSION}-alpine AS base
ENV PNPM_HOME=/pnpm
ENV PATH=$PNPM_HOME:$PATH
RUN npm install -g corepack@latest \
    && corepack enable pnpm \
    && apk add --no-cache libc6-compat
WORKDIR /app

#----------------------
# Prepare (turbo prune)
#----------------------
FROM base AS prepare
# Install turbo globally
RUN pnpm add -g turbo@^2
# Copy all files needed for turbo prune
COPY . .
# Generate pruned monorepo with isolated lockfile
# Extract workspace name from APP_DIR (e.g., "apps/admin" -> "admin")
ARG APP_DIR
RUN WORKSPACE_NAME=$(basename "${APP_DIR}") && \
    turbo prune "${WORKSPACE_NAME}" --docker

#----------------------
# Dependencies (pnpm workspace)
#----------------------
FROM base AS deps
# Install turbo globally for build stage
RUN pnpm add -g turbo@^2
# Copy only dependency files (package.json, lockfile, etc.)
COPY --from=prepare /app/out/json/ .
RUN --mount=type=cache,id=pnpm-store,target=/pnpm/store \
    pnpm install --frozen-lockfile

#----------------------
# Build
#----------------------
FROM deps AS build
# Copy pruned source files
COPY --from=prepare /app/out/full/ .

# Optional: Remote caching support
ENV TURBO_TEAM=analista7-3062
ENV TURBO_TOKEN=GnzbYneGpZGLIkIJHC0jhQeG

ARG APP_DIR
ENV APP_DIR=$APP_DIR
RUN --mount=type=cache,id=pnpm-store,target=/pnpm/store \
    WORKSPACE_NAME=$(basename "${APP_DIR}") && \
    turbo build --filter="${WORKSPACE_NAME}"...

#----------------------
# Runtime (Next.js standalone output)
#----------------------
FROM node:${NODE_VERSION}-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# Copy only the built app output
ARG APP_DIR
ENV APP_DIR=$APP_DIR

# Next.js standalone
COPY --from=build /app/${APP_DIR}/.next/standalone ./
COPY --from=build /app/${APP_DIR}/public ./${APP_DIR}/public
COPY --from=build /app/${APP_DIR}/.next/static ./${APP_DIR}/.next/static

# Set correct permissions
RUN chown -R nextjs:nodejs /app
USER nextjs

# Ensure we start the server from the app directory inside standalone
WORKDIR /app/${APP_DIR}

EXPOSE 3000
ENV PORT=3000
CMD ["node", "server.js"]